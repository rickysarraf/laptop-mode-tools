#! /bin/sh
#
# Laptop mode tools module to handle CPU Hot Plugging
#


# Determine number cpu cores on machine
max_available_cpus() {
    CPU=/sys/devices/system/cpu/present
    if [ -f $CPU ]; then
        max_cpu=$(cat $CPU | cut -d '-' -f2);
        max_cpu=$(expr $max_cpu + 1);
        echo $max_cpu;
    else
        echo -1;
    fi
}


get_numeric_val() {
    num_cpu=`max_available_cpus`;

    case "$1" in
        "quarter")
            disable_cpus=$(echo $num_cpu*1/4 | bc);
            ;;
        "half")
            disable_cpus=$(echo $num_cpu*1/2 | bc);
            ;;
        "3quarter")
            disable_cpus=$(echo $num_cpu*3/4 | bc);
            ;;
        [0-9]*)
            disable_cpus=$1;
            ;;
    esac
}


if [ x$CONTROL_CPU_HOTPLUG = x1 ] || [ x$ENABLE_AUTO_MODULES = x1 -a x$CONTROL_CPU_HOTPLUG = xauto ]; then
    if [ $ON_AC -eq 1 ] ; then
        if [ "$ACTIVATE" -eq 1 ] ; then
            ECHO_VAL="$LM_AC_CPU_HOTPLUG"
        else
            ECHO_VAL="$NOLM_AC_CPU_HOTPLUG"
        fi
    else
        ECHO_VAL="$BATT_CPU_HOTPLUG"
    fi

    counter=0
    get_numeric_val $DISABLE_AVAILABLE_CPU

    for cpu in $(seq 0 $((`max_available_cpus` - 1)) | sort -r); do
        cpupath="/sys/devices/system/cpu/cpu$cpu"

        if [ -e "$cpupath/online" ]; then
            if [ x$ECHO_VAL = x1 ] && [ $counter -lt $disable_cpus ]; then
                log "VERBOSE" "CPU $cpu offline"
                echo 0 > $cpupath/online
                counter=$(($counter + 1))
            else
                log "VERBOSE" "CPU $cpu online"
                echo 1 > $cpupath/online
            fi
        else
            log "VERBOSE" "CPU $cpu cannot be hot plugged";
        fi
    done
fi
